<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0/EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pj1.mapper.OrderlistMapper">

	<select id="selectOrderlist" parameterType="int" resultType="pj1.dto.OrderlistDto">
		select mem_idx, order_num, item_num, item_amount, item_name, item_price, order_status,
		date_format(order_date, '%Y.%m.%d') as order_date
		from orderlist where mem_idx=#{memIdx} and refund_yn = 'N' order by order_date desc
	
	</select>
	
	<select id="selectRefund" parameterType="int" resultType="pj1.dto.OrderlistDto">
		select mem_idx, item_name, order_num, refund_amount, refund_reason, refund_status,
		date_format(refund_date, '%Y.%m.%d') as refund_date
		from refund where mem_idx=#{memIdx} order by refund_date desc
	</select>

	<select id="selectAbleReview" parameterType="int" resultType="pj1.dto.OrderlistDto">
		select r.review_idx, o.item_name, o.mem_idx, o.order_num, r.item_num, r.review_write_yn, 
		r.review_contents, date_format(o.order_date, '%Y.%m.%d') as order_date ,date_format(r.review_writeDate, '%Y.%m.%d') as review_writeDate 
		from review r left join orderlist o on r.order_num = o.order_num 
		where r.mem_idx =#{memIdx} and o.refund_yn = 'N' and r.review_write_yn = 'N' and o.order_status = '구매확정' order by order_date desc
	</select>
	
	<update id="insertReview" parameterType="pj1.dto.OrderlistDto" >
		update review set review_contents = #{reviewContents}, review_write_yn = 'Y', review_writeDate = now() where order_Num = #{orderNum}
	</update>
	
	<select id="selectDidReview" parameterType="int" resultType="pj1.dto.OrderlistDto">
		select review_idx, review_contents, date_format(review_writeDate, '%Y.%m.%d') as review_writeDate from review where review_write_yn = 'Y' order by review_idx desc
	</select>
	
	<select id="selectReviewDetail" parameterType="int" resultType="pj1.dto.OrderlistDto">
		select review_idx, item_num, item_name review_contents from review where review_idx = #{reviewIdx}
	</select>

	<update id="updateReview" parameterType="pj1.dto.OrderlistDto" >
		update review set review_contents = #{reviewContents}, review_updateDate = now() where review_idx = #{reviewIdx}
	</update>
	
	<update id="orderCancelNow" parameterType="int" >
		update orderlist set order_status = '취소완료' where order_Num = #{orderNum}
	</update>
	
	<update id="orderCancelPlz" parameterType="int" >
		update orderlist set order_status = '취소처리중' where order_Num = #{orderNum}
	</update>
	
	<update id="itemPurchase" parameterType="int" >
		update orderlist set order_status = '구매확정' where order_Num = #{orderNum}
	</update>
	
	<insert id="insertAbleReview" parameterType="pj1.dto.OrderlistDto">
		insert into review(mem_idx, item_num, item_name, order_num) values(#{memIdx}, #{itemNum}, #{itemName}, #{orderNum})
	</insert>
	
</mapper>